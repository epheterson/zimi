<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zimi</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0b; --surface: #141416; --surface2: #1c1c20;
    --border: #27272b; --text: #e8e8ed; --text2: #6e6e7a;
    --accent: #f5f5f7; --amber: #f59e0b; --amber2: #d97706;
    --amber-glow: rgba(245, 158, 11, 0.08); --amber-border: rgba(245, 158, 11, 0.25);
    --radius: 10px;
    font-family: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", sans-serif;
  }

  body { background: var(--bg); color: var(--text); min-height: 100vh; padding-top: 56px; }

  /* ── Topbar ── */
  .topbar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 200;
    height: 56px; display: flex; align-items: center; gap: 10px;
    padding: 0 16px; background: rgba(10, 10, 11, 0.85); backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border-bottom: 1px solid var(--border);
  }
  .topbar .logo {
    font-size: 18px; font-weight: 700; letter-spacing: -0.5px;
    text-decoration: none; white-space: nowrap; flex-shrink: 0; cursor: pointer;
    background: linear-gradient(135deg, #f59e0b, #f97316, #ef4444);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text; transition: opacity 0.15s;
  }
  .topbar .logo:hover { opacity: 0.8; }

  .back-btn {
    display: none; align-items: center; justify-content: center;
    background: none; border: 1px solid transparent; border-radius: var(--radius);
    color: var(--text2); font-size: 18px; padding: 4px 8px; cursor: pointer;
    flex-shrink: 0; transition: all 0.2s; line-height: 1;
    position: absolute; left: 16px; z-index: 1;
  }
  .back-btn:hover { color: var(--amber); border-color: var(--amber-border); background: var(--amber-glow); }

  .topbar-breadcrumb { display: flex; align-items: center; gap: 6px; flex-shrink: 0; min-width: 0; }
  .bc-sep { color: var(--text2); font-size: 14px; opacity: 0.4; }
  .bc-context {
    font-size: 14px; font-weight: 500; color: var(--accent);
    text-decoration: none; cursor: pointer; white-space: nowrap;
    overflow: hidden; text-overflow: ellipsis; max-width: 200px; transition: color 0.15s;
  }
  .bc-context:hover { color: var(--amber); }

  .topbar-search { flex: 1; position: relative; }
  .topbar-search input {
    width: 100%; padding: 9px 14px 9px 36px;
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    color: var(--text); font-size: 14px; outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .topbar-search input:focus {
    border-color: var(--amber-border);
    box-shadow: 0 0 0 3px var(--amber-glow), 0 0 20px var(--amber-glow);
  }
  .topbar-search input::placeholder { color: var(--text2); }
  .topbar-search .search-icon {
    position: absolute; left: 11px; top: 50%; transform: translateY(-50%);
    width: 14px; height: 14px; color: var(--text2); pointer-events: none;
  }
  .topbar-search .kbd {
    position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
    font-size: 11px; color: var(--text2); background: var(--surface2);
    border: 1px solid var(--border); border-radius: 4px; padding: 1px 6px;
    font-family: inherit; pointer-events: none; opacity: 0.7; transition: opacity 0.15s;
  }
  .topbar-search input:focus ~ .kbd { opacity: 0; }

  /* ── Suggest dropdown ── */
  .suggest-dropdown {
    position: absolute; top: 100%; left: 0; right: 0;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 0 0 var(--radius) var(--radius);
    display: none; z-index: 300; max-height: 300px; overflow-y: auto;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  .suggest-item {
    padding: 8px 14px; cursor: pointer; font-size: 13px; transition: background 0.1s;
  }
  .suggest-item:hover, .suggest-item.active { background: var(--amber-glow); }
  .suggest-item .sg-title { color: var(--text); }
  .suggest-item .sg-source { font-size: 11px; color: var(--text2); margin-top: 1px; }

  .random-btn {
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; color: var(--text2); text-decoration: none;
    flex-shrink: 0; padding: 6px 10px;
    border-radius: var(--radius); transition: all 0.2s; border: 1px solid transparent;
  }
  .random-btn:hover { color: var(--amber); border-color: var(--amber-border); background: var(--amber-glow); }
  .random-btn .dice { display: inline-block; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
  .random-btn:hover .dice { transform: rotate(20deg) scale(1.15); }
  .random-btn.rolling .dice { animation: diceRoll 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); }
  @keyframes diceRoll {
    0% { transform: rotate(0deg) scale(1); }
    30% { transform: rotate(180deg) scale(1.3); }
    60% { transform: rotate(360deg) scale(0.9); }
    100% { transform: rotate(360deg) scale(1); }
  }
  .manage-btn {
    display: none; align-items: center; justify-content: center;
    font-size: 16px; color: var(--text2); text-decoration: none;
    flex-shrink: 0; padding: 6px 10px;
    border-radius: var(--radius); transition: all 0.2s; border: 1px solid transparent;
  }
  .manage-btn:hover { color: var(--amber); border-color: var(--amber-border); background: var(--amber-glow); }
  .newtab-btn {
    display: none; align-items: center; justify-content: center;
    color: var(--text2); text-decoration: none;
    flex-shrink: 0; padding: 6px 10px;
    border-radius: var(--radius); transition: all 0.2s; border: 1px solid transparent;
  }
  .newtab-btn:hover { color: var(--amber); border-color: var(--amber-border); background: var(--amber-glow); }

  /* ── Layout ── */
  .container { max-width: 820px; margin: 0 auto; padding: 28px 16px; }

  /* ── Stats bar ── */
  .stats-bar { text-align: center; padding: 8px 0 20px; font-size: 14px; color: var(--text2); }
  .stats-bar .num { color: var(--amber); font-weight: 600; }

  /* ── Pills (categories + search source filters) ── */
  .pills { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; margin-bottom: 20px; }
  .pill {
    padding: 6px 14px; font-size: 12px; font-weight: 500;
    background: var(--surface); border: 1px solid var(--border); border-radius: 20px;
    color: var(--text2); cursor: pointer; transition: all 0.2s;
  }
  .pill:hover { border-color: var(--amber-border); color: var(--text); background: var(--amber-glow); }
  .pill.active {
    background: linear-gradient(135deg, var(--amber), var(--amber2));
    color: #000; border-color: transparent; font-weight: 600;
  }

  /* ── Category headings ── */
  .cat-heading {
    font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
    margin: 32px 0 10px; padding-left: 2px;
    background: linear-gradient(90deg, var(--amber), var(--text2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .cat-heading:first-child { margin-top: 0; }

  /* ── Source header ── */
  .source-header {
    display: flex; gap: 16px; align-items: flex-start; padding: 4px 0 24px;
  }
  .sh-icon {
    width: 64px; height: 64px; flex-shrink: 0; border-radius: 12px; overflow: hidden;
    background: var(--surface2); display: flex; align-items: center; justify-content: center;
  }
  .sh-icon img { width: 64px; height: 64px; object-fit: cover; background: #fff; }
  .sh-info { flex: 1; min-width: 0; }
  .source-header h1 { font-size: 20px; font-weight: 600; color: var(--accent); margin: 0; }
  .sh-meta { font-size: 13px; color: var(--text2); margin-top: 4px; }
  .sh-desc { font-size: 13px; color: var(--text2); margin-top: 4px; line-height: 1.5; }

  /* ── Source cards ── */
  .stats-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 8px; margin-top: 8px;
  }
  .stat-card {
    background: var(--surface); border-radius: var(--radius); padding: 14px;
    border: 1px solid var(--border);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex; gap: 14px; align-items: flex-start; text-decoration: none; color: inherit; cursor: pointer;
  }
  .stat-card:hover, .stat-card:focus-visible {
    background: var(--surface2); border-color: var(--amber-border);
    box-shadow: 0 4px 24px var(--amber-glow), 0 0 0 1px var(--amber-glow);
    transform: translateY(-2px); outline: none;
  }
  .card-icon {
    width: 48px; height: 48px; flex-shrink: 0; border-radius: 10px; overflow: hidden;
    background: var(--surface2); display: flex; align-items: center; justify-content: center;
  }
  .card-icon img { width: 48px; height: 48px; object-fit: cover; background: #fff; border-radius: 8px; }
  .icon-letter {
    font-size: 20px; font-weight: 700;
    background: linear-gradient(135deg, var(--amber), #f97316);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .card-info { flex: 1; min-width: 0; }
  .stat-card .name { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 2px; }
  .stat-card .desc {
    font-size: 12px; color: var(--text2); line-height: 1.4; margin-bottom: 4px;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  .stat-card .detail { font-size: 11px; color: var(--text2); opacity: 0.6; }

  /* ── Search results ── */
  .meta { display: flex; gap: 12px; align-items: center; margin-bottom: 20px; font-size: 12px; color: var(--text2); }
  .meta .count { color: var(--amber); font-weight: 600; }
  .meta .time { opacity: 0.6; }

  .results { display: flex; flex-direction: column; gap: 3px; }
  .result {
    padding: 14px 16px; background: var(--surface); border-radius: var(--radius);
    cursor: pointer; border: 1px solid transparent;
    transition: all 0.2s; opacity: 0; animation: fadeUp 0.3s ease forwards;
  }
  .result:hover, .result:focus-visible {
    background: var(--surface2); border-color: var(--amber-border);
    box-shadow: 0 2px 12px var(--amber-glow);
    transform: translateX(4px); outline: none;
  }
  .result-source {
    display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
  }
  .result-source img { width: 20px; height: 20px; border-radius: 4px; flex-shrink: 0; background: #fff; }
  .result-source .rs-letter {
    width: 20px; height: 20px; border-radius: 4px; background: var(--surface2);
    display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: var(--text2); flex-shrink: 0;
  }
  .result-source .rs-name { font-size: 12px; color: var(--text2); font-weight: 500; }
  .result .title { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 4px; }
  .result .snippet {
    font-size: 13px; color: var(--text2); line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    transition: opacity 0.3s;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .result:nth-child(1) { animation-delay: 0s; }
  .result:nth-child(2) { animation-delay: 0.04s; }
  .result:nth-child(3) { animation-delay: 0.08s; }
  .result:nth-child(4) { animation-delay: 0.12s; }
  .result:nth-child(5) { animation-delay: 0.16s; }
  .result:nth-child(n+6) { animation-delay: 0.2s; }

  /* ── Load more ── */
  .load-more {
    text-align: center; padding: 16px;
  }
  .load-more button {
    padding: 10px 24px; font-size: 13px; font-weight: 500; cursor: pointer;
    background: var(--surface); color: var(--text); border: 1px solid var(--border);
    border-radius: var(--radius); transition: all 0.2s;
  }
  .load-more button:hover {
    border-color: var(--amber-border); background: var(--amber-glow);
  }

  /* ── Reader ── */
  .reader-view {
    position: fixed; top: 56px; left: 0; right: 0; bottom: 0;
    display: none; flex-direction: column; z-index: 100; background: var(--bg);
  }
  .reader-view.open { display: flex; animation: fadeIn 0.15s ease; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  #reader-frame { flex: 1; border: none; width: 100%; background: #fff; }
  .reader-loading {
    position: absolute; inset: 0; display: flex; align-items: center;
    justify-content: center; flex-direction: column; gap: 12px;
    background: var(--bg); color: var(--text2); font-size: 13px;
    z-index: 5; transition: opacity 0.3s;
  }
  .reader-loading.hidden { opacity: 0; pointer-events: none; }
  .reader-loading .spinner {
    width: 24px; height: 24px; border: 2px solid var(--border);
    border-top-color: var(--amber); border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Footer ── */
  .footer {
    text-align: center; padding: 32px 16px 24px;
    font-size: 12px; color: var(--text2); opacity: 0.5;
    border-top: 1px solid var(--border); margin-top: 40px;
  }
  .footer .footer-brand {
    background: linear-gradient(135deg, #f59e0b, #f97316);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text; font-weight: 600; text-decoration: none;
  }
  .footer .footer-brand:hover { opacity: 0.8; }

  /* ── Utility ── */
  .loading { text-align: center; padding: 40px; color: var(--text2); font-size: 13px; }
  .loading .spinner-inline {
    display: inline-block; width: 14px; height: 14px;
    border: 2px solid var(--border); border-top-color: var(--amber);
    border-radius: 50%; animation: spin 0.7s linear infinite;
    vertical-align: middle; margin-right: 8px;
  }
  .empty { text-align: center; padding: 48px 20px; color: var(--text2); }
  .empty p { font-size: 14px; margin-bottom: 8px; }
  .empty .hint { font-size: 12px; opacity: 0.5; }
  #main-view.hidden { display: none; }

  /* ── Manage page ── */
  .manage-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 20px; margin-bottom: 16px;
  }
  .manage-card h2 {
    font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 12px;
  }
  .manage-card .mc-row {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 13px; color: var(--text2); padding: 4px 0;
  }
  .manage-card .mc-row .mc-label { color: var(--text2); }
  .manage-card .mc-row .mc-value { color: var(--text); font-weight: 500; }
  .manage-btn-action {
    padding: 8px 18px; font-size: 13px; font-weight: 500; cursor: pointer;
    background: linear-gradient(135deg, var(--amber), var(--amber2));
    color: #000; border: none; border-radius: var(--radius);
    transition: opacity 0.2s;
  }
  .manage-btn-action:hover { opacity: 0.85; }
  .manage-btn-action:disabled { opacity: 0.4; cursor: default; }
  .manage-search { margin-bottom: 16px; display: flex; gap: 8px; }
  .manage-search input {
    flex: 1; padding: 9px 14px; background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); color: var(--text); font-size: 14px; outline: none;
  }
  .manage-search input:focus { border-color: var(--amber-border); }
  .manage-search select {
    padding: 9px 12px; background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); color: var(--text); font-size: 13px; outline: none;
  }
  .catalog-item {
    display: flex; gap: 14px; align-items: flex-start; padding: 14px;
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    margin-bottom: 6px; transition: border-color 0.2s;
  }
  .catalog-item:hover { border-color: var(--amber-border); }
  .catalog-item .ci-info { flex: 1; min-width: 0; }
  .catalog-item .ci-title { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 2px; }
  .catalog-item .ci-summary {
    font-size: 12px; color: var(--text2); line-height: 1.4; margin-bottom: 4px;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
  }
  .catalog-item .ci-meta { font-size: 11px; color: var(--text2); opacity: 0.6; }
  .catalog-item .ci-actions { flex-shrink: 0; display: flex; align-items: center; }
  .ci-installed {
    font-size: 11px; color: var(--amber); font-weight: 600; padding: 4px 10px;
    border: 1px solid var(--amber-border); border-radius: 12px; background: var(--amber-glow);
  }
  .ci-add-btn {
    padding: 6px 14px; font-size: 12px; font-weight: 500; cursor: pointer;
    background: var(--surface2); color: var(--text); border: 1px solid var(--border);
    border-radius: var(--radius); transition: all 0.2s;
  }
  .ci-add-btn:hover { border-color: var(--amber-border); background: var(--amber-glow); }
  .dl-item {
    display: flex; gap: 12px; align-items: center; padding: 10px 14px;
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    margin-bottom: 6px; font-size: 13px;
  }
  .dl-item .dl-name { flex: 1; color: var(--text); font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .dl-item .dl-size { color: var(--text2); flex-shrink: 0; }
  .dl-item .dl-time { color: var(--text2); opacity: 0.6; flex-shrink: 0; }
  .dl-item .dl-done { color: var(--amber); font-weight: 600; }

  /* ── Mobile ── */
  /* ── Results summary ── */
  .results-summary {
    text-align: center; padding: 16px 0 4px; font-size: 12px; color: var(--text2); opacity: 0.6;
  }

  /* ── Footer ── */
  .footer-sub { margin-top: 6px; font-size: 11px; opacity: 0.7; }
  .footer a { color: var(--amber); text-decoration: none; }
  .footer a:hover { text-decoration: underline; }
  .kbd-hints { opacity: 0.6; }

  /* ── Mobile ── */
  @media (max-width: 600px) {
    .topbar { padding: 0 10px; gap: 6px; }
    .topbar .logo { font-size: 16px; }
    .bc-context { max-width: 120px; }
    .stats-grid { grid-template-columns: 1fr; }
    .container { padding: 20px 12px; }
    .topbar-search .kbd { display: none; }
    .kbd-hints { display: none; }
  }

  /* ── Reduced motion ── */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
  }
</style>
</head>
<body>

<nav class="topbar" aria-label="Main navigation">
  <button id="back-btn" class="back-btn" onclick="goBack()" aria-label="Go back" style="display:none">&larr;</button>
  <div class="topbar-breadcrumb" onclick="bcClick(event)">
    <a id="logo" class="logo" onclick="goHome(event)">Zimi</a>
    <span id="bc-sep" class="bc-sep" style="display:none">/</span>
    <a id="bc-context" class="bc-context" style="display:none"></a>
  </div>
  <div class="topbar-search">
    <input type="text" id="q" placeholder="Search everything..." autofocus aria-label="Search">
    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path stroke-linecap="round" d="m21 21-4.3-4.3"/></svg>
    <span class="kbd">/</span>
    <div id="suggest-dropdown" class="suggest-dropdown"></div>
  </div>
  <a href="#" id="random-btn" class="random-btn" title="Random article (R)" onclick="randomArticle(event)"><span class="dice">&#x1F3B2;</span></a>
  <a href="#" id="manage-btn" class="manage-btn" title="Library Manager" onclick="toggleManage(event)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></a>
  <a id="newtab-btn" class="newtab-btn" href="#" target="_blank" rel="noopener" title="Open in new tab"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg></a>
</nav>

<noscript>
  <div style="max-width:520px;margin:40px auto;padding:20px;text-align:center;color:#e8e8ed">
    <h1 style="font-size:20px;margin-bottom:8px">Zimi</h1>
    <p>Zimi requires JavaScript to browse your offline knowledge library.</p>
    <p style="margin-top:8px;opacity:0.6;font-size:13px">The API endpoints (/search, /read, /list) work without JS.</p>
  </div>
</noscript>

<main id="main-view">
  <div class="container">
    <div id="stats-bar" class="stats-bar"></div>
    <div id="pills-bar" class="pills"></div>
    <div id="source-header" style="display:none"></div>
    <div class="meta" id="search-meta" style="display:none">
      <span class="count" id="search-count"></span>
      <span class="time" id="search-time"></span>
    </div>
    <div id="output"></div>
  </div>
  <footer id="footer" class="footer" style="display:none">
    <a href="https://github.com/epheterson/zimi" target="_blank" rel="noopener" class="footer-brand">Zimi</a> &middot; Powered by <a href="https://kiwix.org" target="_blank" rel="noopener">Kiwix</a>
    <div class="footer-sub"><span class="kbd-hints"><kbd>/</kbd> Search &middot; <kbd>R</kbd> Random &middot; <kbd>Esc</kbd> Back</span></div>
  </footer>
</main>

<div id="reader" class="reader-view">
  <div class="reader-loading" id="reader-loading"><div class="spinner"></div><span>Loading...</span></div>
  <iframe id="reader-frame" title="Article content" sandbox="allow-same-origin allow-scripts allow-popups"></iframe>
</div>

<script>
// ── State ──
let mode = 'home'; // 'home' | 'source' | 'search' | 'manage'
let currentSource = null;
let readerOpen = false;
let readerSource = null; // ZIM name of what's in reader (for topbar badge when no explicit source)
let sourceAutoReader = false; // true when enterSource auto-opened the reader (non-zimgit homepage)
let zimsCache = null;
let manageEnabled = false;
let activeCategories = new Set();
let activeSourceFilters = new Set();
let allResults = {};
let searchController = null;
let searchTimer = null;
let suggestTimer = null;
let suggestItems = [];
let suggestIndex = -1;
let snippetController = null;

const RESULTS_PER_PAGE = 20;
let visibleResultCount = RESULTS_PER_PAGE;

// ── DOM refs ──
const q = document.getElementById('q');
const output = document.getElementById('output');
const mainView = document.getElementById('main-view');
const statsBar = document.getElementById('stats-bar');
const pillsBar = document.getElementById('pills-bar');
const sourceHeaderEl = document.getElementById('source-header');
const searchMeta = document.getElementById('search-meta');
const logoEl = document.getElementById('logo');
const backBtn = document.getElementById('back-btn');
const bcSep = document.getElementById('bc-sep');
const bcContext = document.getElementById('bc-context');
const randomBtn = document.getElementById('random-btn');
const manageBtnEl = document.getElementById('manage-btn');
const _gearSvg = manageBtnEl.innerHTML; // capture gear icon for toggle
const newtabBtn = document.getElementById('newtab-btn');
const suggestDropdown = document.getElementById('suggest-dropdown');
const footerEl = document.getElementById('footer');

// ── Topbar ──
function updateTopbar() {
  const activeSource = currentSource || readerSource;
  const showBack = readerOpen || mode === 'source' || mode === 'search';

  // Back arrow & logo share the same slot (back-btn is position:absolute)
  backBtn.style.display = showBack ? 'flex' : 'none';
  logoEl.style.display = showBack ? 'none' : '';

  // Breadcrumb: Zimi / SourceName
  if (activeSource) {
    bcSep.style.display = 'inline';
    bcContext.style.display = 'inline';
    bcContext.textContent = _zimTitle(activeSource);
    bcContext.onclick = (e) => {
      e.preventDefault(); e.stopPropagation();
      if (readerOpen) closeReader();
      if (currentSource) enterSource(currentSource, false);
    };
  } else {
    bcSep.style.display = 'none';
    bcContext.style.display = 'none';
  }

  // Manage: gear → X close button, keep breadcrumb as-is
  if (mode === 'manage') {
    manageBtnEl.style.display = 'flex';
    manageBtnEl.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
    manageBtnEl.title = 'Close';
    manageBtnEl.style.color = 'var(--amber)';
    manageBtnEl.style.borderColor = 'var(--amber-border)';
    manageBtnEl.style.background = 'var(--amber-glow)';
  } else {
    manageBtnEl.style.display = manageEnabled && !activeSource ? 'flex' : 'none';
    manageBtnEl.innerHTML = _gearSvg;
    manageBtnEl.title = 'Library Manager';
    manageBtnEl.style.color = '';
    manageBtnEl.style.borderColor = '';
    manageBtnEl.style.background = '';
  }

  newtabBtn.style.display = readerOpen ? 'flex' : 'none';
  randomBtn.style.display = mode !== 'manage' ? 'flex' : 'none';

  // Search placeholder
  if (currentSource) {
    q.placeholder = 'Search ' + _zimTitle(currentSource) + '...';
  } else if (mode === 'manage') {
    q.placeholder = 'Search Kiwix library...';
  } else {
    q.placeholder = 'Search everything...';
  }

  // Footer
  updateFooter();
}

function bcClick(e) {
  // Clicking the breadcrumb area (not logo or context) acts as back
  if (e.target.id === 'logo' || e.target.id === 'bc-context') return;
  goBack();
}

function updateFooter() {
  if (readerOpen) {
    footerEl.style.display = 'none';
  } else {
    footerEl.style.display = '';
  }
}

// ── Init ──
async function init() {
  try {
    const res = await fetch('/list');
    zimsCache = await res.json();
  } catch(e) { zimsCache = []; }
  try {
    const mres = await fetch('/manage/status');
    if (mres.ok) {
      const mdata = await mres.json();
      manageEnabled = !!mdata.manage_enabled;
    }
  } catch(e) {}
  route(false);
}

function route(push) {
  const path = location.pathname;
  const search = location.search;
  if (search === '?manage' && manageEnabled) { enterManage(); return; }
  if (path.startsWith('/w/')) {
    const rest = decodeURIComponent(path.slice(3));
    const name = rest.split('/')[0];
    if (name) { enterSource(name, push); return; }
  }
  if (zimsCache && zimsCache.length === 1) {
    enterSource(zimsCache[0].name, false);
    history.replaceState(null, '', '/w/' + encodeURIComponent(zimsCache[0].name));
    return;
  }
  enterHome(push);
}

// ── Navigation ──
function goHome(e) {
  if (e) e.preventDefault();
  closeReader();
  currentSource = null;
  readerSource = null;
  sourceAutoReader = false;
  activeCategories.clear();
  enterHome(true);
}

function goBack() {
  if (readerOpen) {
    closeReader();
    // Only go home if reader was auto-opened by enterSource AND user hasn't searched
    if (sourceAutoReader) {
      sourceAutoReader = false;
      currentSource = null;
      enterHome(false);
    }
    // Otherwise mainView still has content (search results, document list, etc)
    return;
  }
  // Not in reader — navigate up the breadcrumb
  if (mode === 'search' && currentSource) {
    // Back from scoped search → return to source
    enterSource(currentSource, false);
  } else {
    goHome(null);
  }
}

function enterHome(push) {
  mode = 'home';
  currentSource = null;
  readerSource = null;
  sourceAutoReader = false;
  q.value = '';
  searchMeta.style.display = 'none';
  sourceHeaderEl.style.display = 'none';
  activeSourceFilters.clear();
  hideSuggest();
  if (push) history.pushState({ mode: 'home' }, '', '/');
  updateTopbar();
  renderHome();
}

async function enterSource(name, push) {
  const info = zimsCache && zimsCache.find(z => z.name === name);
  if (!info) { enterHome(push); return; }
  mode = 'source';
  currentSource = name;
  readerSource = null;
  sourceAutoReader = false;
  q.value = '';
  searchMeta.style.display = 'none';
  activeSourceFilters.clear();
  hideSuggest();
  if (push) history.pushState({ mode: 'source', source: name }, '', '/w/' + encodeURIComponent(name));
  updateTopbar();
  await renderSource(name);
}

// ── Render: Home ──
function renderHome() {
  if (!zimsCache || zimsCache.length === 0) {
    statsBar.innerHTML = ''; statsBar.style.display = 'none';
    pillsBar.innerHTML = ''; pillsBar.style.display = 'none';
    output.innerHTML = '<div class="empty"><p>No knowledge sources found</p><p class="hint">Add ZIM files to get started</p></div>';
    return;
  }

  const total = zimsCache.reduce((s, z) => s + (typeof z.entries === 'number' ? z.entries : 0), 0);
  const gb = zimsCache.reduce((s, z) => s + z.size_gb, 0).toFixed(0);

  if (zimsCache.length > 1) {
    statsBar.innerHTML = '<span class="num">' + zimsCache.length + '</span> sources &middot; ' +
      '<span class="num">' + total.toLocaleString() + '</span> articles &middot; ' +
      '<span class="num">' + gb + '</span> GB';
    statsBar.style.display = '';
  } else {
    statsBar.style.display = 'none';
  }

  const groups = {};
  const sorted = zimsCache.filter(z => z.entries !== '?').sort((a, b) => (b.entries || 0) - (a.entries || 0));
  sorted.forEach(z => {
    const key = z.category || '_uncategorized';
    if (!groups[key]) groups[key] = [];
    groups[key].push(z);
  });

  const cats = Object.keys(groups).filter(c => c !== '_uncategorized').sort();

  // No pills on home — sections provide the organization
  pillsBar.innerHTML = ''; pillsBar.style.display = 'none';

  let h = '';
  cats.forEach(cat => {
    h += '<div class="cat-heading">' + esc(cat) + '</div>';
    h += renderCardGrid(groups[cat]);
  });
  if (groups._uncategorized) {
    h += '<div class="cat-heading" style="opacity:0.5">Other</div>';
    h += renderCardGrid(groups._uncategorized);
  }

  output.innerHTML = h;
}

function renderCardGrid(items) {
  if (!items || !items.length) return '';
  return '<div class="stats-grid">' + items.map(z => {
    const icon = z.has_icon
      ? '<img src="/w/' + encodeURIComponent(z.name) + '/-/icon" width="48" height="48" loading="lazy">'
      : '<span class="icon-letter">' + esc(z.title || z.name)[0].toUpperCase() + '</span>';
    return '<div class="stat-card" tabindex="0" role="button" onclick="enterSource(\'' + escAttr(z.name) + '\', true)" onkeydown="if(event.key===\'Enter\')enterSource(\'' + escAttr(z.name) + '\', true)">' +
      '<div class="card-icon">' + icon + '</div>' +
      '<div class="card-info">' +
        '<div class="name">' + esc(z.title || z.name) + '</div>' +
        (z.description ? '<div class="desc">' + esc(z.description) + '</div>' : '') +
        '<div class="detail">' + (typeof z.entries === 'number' ? z.entries.toLocaleString() + ' entries' : '') +
        ' &middot; ' + z.size_gb + ' GB</div>' +
      '</div></div>';
  }).join('') + '</div>';
}

function toggleCategory(cat) {
  if (activeCategories.has(cat)) activeCategories.delete(cat);
  else activeCategories.add(cat);
  renderHome();
}

// ── Render: Source ──
async function renderSource(name) {
  const info = zimsCache.find(z => z.name === name);
  if (!info) return;

  statsBar.style.display = 'none';
  pillsBar.innerHTML = ''; pillsBar.style.display = 'none';

  // Source header
  const iconHtml = info.has_icon
    ? '<img src="/w/' + encodeURIComponent(name) + '/-/icon" width="64" height="64">'
    : '<span class="icon-letter" style="font-size:28px">' + esc(info.title || name)[0].toUpperCase() + '</span>';

  sourceHeaderEl.innerHTML = '<div class="source-header">' +
    '<div class="sh-icon">' + iconHtml + '</div>' +
    '<div class="sh-info">' +
      '<h1>' + esc(info.title || name) + '</h1>' +
      '<div class="sh-meta">' + (typeof info.entries === 'number' ? info.entries.toLocaleString() + ' entries' : '') +
      ' &middot; ' + info.size_gb + ' GB</div>' +
      (info.description ? '<div class="sh-desc">' + esc(info.description) + '</div>' : '') +
    '</div></div>';
  sourceHeaderEl.style.display = '';

  output.innerHTML = '<div class="loading"><span class="spinner-inline"></span>Loading...</div>';

  // Try catalog first (zimgit PDF collections show document list)
  try {
    const res = await fetch('/catalog?zim=' + encodeURIComponent(name));
    const data = await res.json();
    if (mode !== 'source' || currentSource !== name) return; // stale
    if (data.documents && data.documents.length) {
      // Zimgit — show document list in main-view
      output.innerHTML = '<div class="cat-heading">' + esc(String(data.count)) + ' Documents</div>' +
        '<div class="results">' + data.documents.map((d, i) => {
          const hasPath = !!d.path;
          const clickAttr = hasPath ? ' onclick="openArticle(\'' + escAttr(name) + '\', \'' + escAttr(d.path) + '\')" onkeydown="if(event.key===\'Enter\')openArticle(\'' + escAttr(name) + '\', \'' + escAttr(d.path) + '\')"' : '';
          return '<div class="result"' + (hasPath ? ' tabindex="0" role="button"' : '') + ' style="animation-delay:' + (i * 0.04) + 's"' + clickAttr + '>' +
            '<div class="title">' + esc(d.title) + '</div>' +
            (d.description ? '<div class="snippet">' + esc(d.description) + '</div>' : '') +
          '</div>';
        }).join('') + '</div>';
      return;
    }
  } catch(e) {}

  // Stale check after catalog fetch
  if (mode !== 'source' || currentSource !== name) return;

  // Non-zimgit — open ZIM homepage in reader
  if (info.main_path) {
    sourceAutoReader = true;
    output.innerHTML = ''; // clear loading, reader will cover main-view
    sourceHeaderEl.style.display = 'none';
    const url = '/w/' + encodeURIComponent(name) + '/' + info.main_path;
    openReader(url);
  } else {
    output.innerHTML = '';
  }
}

// ── Search ──
q.addEventListener('input', () => {
  clearTimeout(searchTimer);
  const val = q.value.trim();
  // Suggest (200ms debounce)
  clearTimeout(suggestTimer);
  if (val && val.length >= 2 && mode !== 'manage') {
    suggestTimer = setTimeout(() => fetchSuggestions(val), 200);
  } else {
    hideSuggest();
  }
  // Full search or clear
  if (!val) { hideSuggest(); clearSearch(); return; }
  if (mode === 'manage') {
    searchTimer = setTimeout(() => {
      const cq = document.getElementById('catalog-q');
      if (cq) { cq.value = val; searchCatalog(); }
    }, 500);
    return;
  }
  searchTimer = setTimeout(() => doSearch(val), 500);
});

q.addEventListener('keydown', e => {
  // Suggest keyboard navigation
  if (suggestDropdown.style.display !== 'none') {
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      suggestIndex = Math.min(suggestIndex + 1, suggestItems.length - 1);
      highlightSuggest();
      return;
    }
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      suggestIndex = Math.max(suggestIndex - 1, -1);
      highlightSuggest();
      return;
    }
    if (e.key === 'Enter' && suggestIndex >= 0) {
      e.preventDefault();
      selectSuggest(suggestIndex);
      return;
    }
    if (e.key === 'Escape') {
      hideSuggest();
      return;
    }
  }
  if (e.key === 'Enter') {
    e.preventDefault();
    clearTimeout(searchTimer);
    hideSuggest();
    if (mode === 'manage') {
      const cq = document.getElementById('catalog-q');
      if (cq) { cq.value = q.value.trim(); searchCatalog(); }
      return;
    }
    doSearch(q.value.trim());
  }
});


async function doSearch(query) {
  if (!query) return;

  // Reject all-stop-word queries (e.g. "what", "the", "is it")
  const STOPS = new Set(['a','an','and','are','as','at','be','by','for','from','has','have','how','i','in','is','it','its','my','not','of','on','or','so','that','the','this','to','was','we','what','when','where','which','who','will','with','you']);
  const meaningful = query.toLowerCase().split(/\s+/).filter(w => !STOPS.has(w));
  if (!meaningful.length) {
    mode = 'search';
    statsBar.style.display = 'none';
    pillsBar.innerHTML = ''; pillsBar.style.display = 'none';
    searchMeta.style.display = 'none';
    output.innerHTML = '<div class="empty"><p>Try more specific keywords</p><p class="hint">Common words like \u201c' + esc(query) + '\u201d match too many articles</p></div>';
    updateTopbar();
    return;
  }

  if (searchController) searchController.abort();
  searchController = new AbortController();

  const scope = currentSource;
  mode = 'search';
  sourceAutoReader = false; // user searched — don't auto-home on back
  visibleResultCount = RESULTS_PER_PAGE;

  // Close reader if open
  if (readerOpen) closeReader();

  mainView.classList.remove('hidden');
  if (!scope) sourceHeaderEl.style.display = 'none';
  statsBar.style.display = 'none';
  pillsBar.innerHTML = ''; pillsBar.style.display = 'none';
  searchMeta.style.display = 'none';
  output.innerHTML = '<div class="loading"><span class="spinner-inline"></span>Searching...</div>';
  updateTopbar();

  const zimParam = scope ? '&zim=' + encodeURIComponent(scope) : '';
  const searchT0 = performance.now();

  try {
    const res = await fetch('/search?q=' + encodeURIComponent(query) + '&limit=10' + zimParam,
      { signal: searchController.signal });
    allResults = await res.json();
    allResults._clientElapsed = ((performance.now() - searchT0) / 1000).toFixed(1);
    // Push search state so browser back from reader returns here
    const searchUrl = scope ? '/w/' + encodeURIComponent(scope) + '?q=' + encodeURIComponent(query) : '/?q=' + encodeURIComponent(query);
    history.pushState({ mode: 'search', query: query, source: scope }, '', searchUrl);
    renderSearchResults(allResults, scope);
  } catch(e) {
    if (e.name === 'AbortError') return;
    output.innerHTML = '<div class="empty"><p>Search failed</p><p class="hint">Try again in a moment.</p></div>';
  }
}

function _sourceIconHtml(zimName, size) {
  const info = zimsCache && zimsCache.find(z => z.name === zimName);
  const title = (info && info.title) || zimName;
  if (info && info.has_icon) {
    return '<img src="/w/' + encodeURIComponent(zimName) + '/-/icon" width="' + size + '" height="' + size + '">';
  }
  return '<span class="rs-letter">' + (esc(title)[0] || 'Z').toUpperCase() + '</span>';
}

function renderSearchResults(data, scope) {
  if (snippetController) { snippetController.abort(); snippetController = null; }
  let items = data.results || [];
  const bySource = data.by_source || {};
  const totalCount = data.total || items.length;

  // Source filter pills (global search only, multiple sources)
  const sourceNames = Object.keys(bySource);
  if (!scope && sourceNames.length > 1) {
    pillsBar.innerHTML = sourceNames.sort().map(s => {
      return '<button class="pill' + (activeSourceFilters.has(s) ? ' active' : '') +
        '" aria-pressed="' + activeSourceFilters.has(s) + '" onclick="toggleSourceFilter(\'' + escAttr(s) + '\')">' +
        esc(_zimTitle(s)) + ' (' + bySource[s] + ')</button>';
    }).join('');
    pillsBar.style.display = '';
  }

  if (activeSourceFilters.size > 0) {
    items = items.filter(r => activeSourceFilters.has(r.zim));
  }

  const displayElapsed = data._clientElapsed || (data.elapsed ? data.elapsed.toFixed(1) : null);
  document.getElementById('search-count').textContent = totalCount + ' results';
  document.getElementById('search-time').textContent = displayElapsed ? 'in ' + displayElapsed + 's' : '';
  searchMeta.style.display = items.length ? 'flex' : 'none';

  if (!items.length) {
    output.innerHTML = '<div class="empty"><p>No results found</p><p class="hint">Try different keywords</p></div>';
    return;
  }

  // Pagination: show only first visibleResultCount items
  const visible = items.slice(0, visibleResultCount);
  const remaining = items.length - visibleResultCount;

  let html = '<div class="results">' + visible.map((r, i) => {
    const sourceRow = !scope
      ? '<div class="result-source">' + _sourceIconHtml(r.zim, 20) +
        '<span class="rs-name">' + esc(_zimTitle(r.zim)) + '</span></div>'
      : '';
    return '<div class="result" tabindex="0" role="button" data-zim="' + escAttr(r.zim) + '" data-path="' + escAttr(r.path) + '" style="animation-delay:' + (Math.min(i, 5) * 0.04) + 's" onclick="openArticle(\'' + escAttr(r.zim) + '\', \'' + escAttr(r.path) + '\')" onkeydown="if(event.key===\'Enter\')openArticle(\'' + escAttr(r.zim) + '\', \'' + escAttr(r.path) + '\')">' +
      sourceRow +
      '<div class="title">' + esc(r.title) + '</div>' +
      (r.snippet ? '<div class="snippet">' + esc(r.snippet) + '</div>' : '<div class="snippet" data-needs-snippet="1"></div>') +
      '</div>';
  }).join('') + '</div>';

  if (remaining > 0) {
    html += '<div class="load-more"><button onclick="showMoreResults()">Show ' +
      Math.min(RESULTS_PER_PAGE, remaining) + ' more results</button></div>';
  }

  if (displayElapsed) {
    html += '<div class="results-summary">Found ' + totalCount + ' results in ' + displayElapsed + 's</div>';
  }

  output.innerHTML = html;

  if (!scope) loadSnippets();
}

function showMoreResults() {
  visibleResultCount += RESULTS_PER_PAGE;
  renderSearchResults(allResults, currentSource);
}

function _zimTitle(name) {
  const info = zimsCache && zimsCache.find(z => z.name === name);
  return (info && info.title) || name;
}

// ── Async Snippets ──
async function loadSnippets() {
  if (snippetController) snippetController.abort();
  snippetController = new AbortController();
  const signal = snippetController.signal;

  const els = document.querySelectorAll('.result [data-needs-snippet="1"]');
  if (!els.length) return;

  const queue = Array.from(els);
  const concurrency = 4;
  let active = 0;
  let idx = 0;

  function next() {
    while (active < concurrency && idx < queue.length) {
      const el = queue[idx++];
      const card = el.closest('.result');
      if (!card) continue;
      const zim = card.dataset.zim;
      const path = card.dataset.path;
      if (!zim || !path) continue;
      active++;
      fetchSnippet(el, zim, path, signal).finally(() => { active--; next(); });
    }
  }
  next();
}

async function fetchSnippet(el, zim, path, signal) {
  try {
    const res = await fetch('/snippet?zim=' + encodeURIComponent(zim) + '&path=' + encodeURIComponent(path), { signal });
    const data = await res.json();
    if (data.snippet) {
      el.textContent = data.snippet;
      el.removeAttribute('data-needs-snippet');
      el.style.opacity = '0';
      requestAnimationFrame(() => { el.style.opacity = '1'; });
    } else {
      el.remove();
    }
  } catch(e) {
    if (e.name !== 'AbortError') el.remove();
  }
}

function toggleSourceFilter(s) {
  if (activeSourceFilters.has(s)) activeSourceFilters.delete(s);
  else activeSourceFilters.add(s);
  visibleResultCount = RESULTS_PER_PAGE;
  renderSearchResults(allResults, null);
}

function clearSearch() {
  activeSourceFilters.clear();
  if (snippetController) { snippetController.abort(); snippetController = null; }
  searchMeta.style.display = 'none';
  visibleResultCount = RESULTS_PER_PAGE;
  if (mode === 'manage') {
    renderManage();
  } else if (currentSource) {
    mode = 'source';
    updateTopbar();
    renderSource(currentSource);
  } else {
    mode = 'home';
    updateTopbar();
    renderHome();
  }
}

// ── Suggest / Autocomplete ──
let suggestController = null;
let _suggestSeq = 0; // sequence counter to discard stale responses

async function fetchSuggestions(query) {
  // Cancel any in-flight suggest request
  if (suggestController) suggestController.abort();
  suggestController = new AbortController();
  const seq = ++_suggestSeq;

  const zimParam = currentSource ? '&zim=' + encodeURIComponent(currentSource) : '';
  try {
    const res = await fetch('/suggest?q=' + encodeURIComponent(query) + '&limit=6' + zimParam,
      { signal: suggestController.signal });
    const data = await res.json();
    // Discard if a newer request has been issued or input lost focus
    if (seq !== _suggestSeq || document.activeElement !== q) return;
    // data is {zim_name: [{path, title}, ...], ...}
    suggestItems = [];
    for (const [zim, items] of Object.entries(data)) {
      for (const item of items) {
        if (item.error) continue;
        suggestItems.push({ zim, path: item.path, title: item.title });
      }
    }
    // Deduplicate by title
    const seen = new Set();
    suggestItems = suggestItems.filter(s => {
      const key = s.title.toLowerCase();
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    }).slice(0, 6);

    if (suggestItems.length) showSuggest();
    else hideSuggest();
  } catch(e) {
    if (e.name !== 'AbortError') hideSuggest();
  }
}

// Close suggestions when clicking anywhere outside the search box/dropdown
document.addEventListener('mousedown', (e) => {
  if (!suggestDropdown.contains(e.target) && e.target !== q) {
    hideSuggest();
  }
});

function showSuggest() {
  suggestIndex = -1;
  suggestDropdown.innerHTML = suggestItems.map((s, i) =>
    '<div class="suggest-item" data-i="' + i + '" onmousedown="selectSuggest(' + i + ')">' +
    '<div class="sg-title">' + esc(s.title) + '</div>' +
    (!currentSource ? '<div class="sg-source">' + esc(_zimTitle(s.zim)) + '</div>' : '') +
    '</div>'
  ).join('');
  suggestDropdown.style.display = 'block';
}

function hideSuggest() {
  suggestDropdown.style.display = 'none';
  suggestIndex = -1;
}

function highlightSuggest() {
  suggestDropdown.querySelectorAll('.suggest-item').forEach((el, i) => {
    el.classList.toggle('active', i === suggestIndex);
  });
}

function selectSuggest(i) {
  const s = suggestItems[i];
  if (!s) return;
  hideSuggest();
  q.value = s.title;
  openArticle(s.zim, s.path);
}

// ── Library Manager ──
function toggleManage(e) {
  if (e) e.preventDefault();
  if (mode === 'manage') { goHome(e); return; }
  enterManage(e);
}

function enterManage(e) {
  if (e) e.preventDefault();
  if (!manageEnabled) return;
  mode = 'manage';
  currentSource = null;
  readerSource = null;
  sourceAutoReader = false;
  q.value = '';
  closeReader();
  statsBar.style.display = 'none';
  pillsBar.innerHTML = ''; pillsBar.style.display = 'none';
  searchMeta.style.display = 'none';
  sourceHeaderEl.style.display = 'none';
  hideSuggest();
  history.pushState({ mode: 'manage' }, '', '/?manage');
  updateTopbar();
  renderManage();
}

async function renderManage() {
  let statusHtml = '<div class="manage-card"><h2>Library Status</h2><div class="loading"><span class="spinner-inline"></span>Loading...</div></div>';
  output.innerHTML = statusHtml + '<div id="manage-catalog"></div><div id="manage-downloads"></div>';

  try {
    const res = await fetch('/manage/status');
    const data = await res.json();
    const statusCard = document.querySelector('.manage-card');
    if (statusCard) {
      statusCard.innerHTML = '<h2>Library Status</h2>' +
        '<div class="mc-row"><span class="mc-label">ZIM files</span><span class="mc-value">' + esc(String(data.zim_count)) + '</span></div>' +
        '<div class="mc-row"><span class="mc-label">Total size</span><span class="mc-value">' + esc(String(data.total_size_gb)) + ' GB</span></div>' +
        '<div id="update-status" class="mc-row" style="display:none"></div>' +
        '<div style="margin-top:12px;display:flex;gap:8px">' +
          '<button class="manage-btn-action" onclick="triggerUpdate()">Run Update</button>' +
          '<button class="manage-btn-action" onclick="refreshLibrary()" style="background:var(--surface2);color:var(--text);border:1px solid var(--border)">Refresh Cache</button>' +
        '</div>';
    }
    // Check for updates in background
    checkForUpdates();
  } catch(e) {
    const statusCard = document.querySelector('.manage-card');
    if (statusCard) {
      statusCard.innerHTML = '<h2>Library Status</h2><div style="color:var(--text2);font-size:13px">Could not load library status</div>';
    }
  }

  const catEl = document.getElementById('manage-catalog');
  if (catEl) {
    catEl.innerHTML = '<div class="manage-card"><h2>Browse Kiwix Library</h2>' +
      '<div class="manage-search">' +
        '<input type="text" id="catalog-q" placeholder="Search for ZIMs..." onkeydown="if(event.key===\'Enter\')searchCatalog()">' +
        '<select id="catalog-lang"><option value="eng">English</option><option value="">All languages</option><option value="fra">French</option><option value="deu">German</option><option value="spa">Spanish</option></select>' +
        '<button class="manage-btn-action" onclick="searchCatalog()">Search</button>' +
      '</div>' +
      '<div id="catalog-results"></div>' +
    '</div>';
  }

  // Auto-load popular ZIMs on open
  searchCatalog();
  refreshDownloads();
}

let catalogPage = 0;

async function searchCatalog(append) {
  const cq = document.getElementById('catalog-q');
  const lang = document.getElementById('catalog-lang');
  const results = document.getElementById('catalog-results');
  if (!results) return;
  if (!append) { catalogPage = 0; results.innerHTML = '<div class="loading"><span class="spinner-inline"></span>Searching Kiwix catalog...</div>'; }

  const query = (cq && cq.value) || '';
  const langVal = (lang && lang.value) || 'eng';
  try {
    const res = await fetch('/manage/catalog?q=' + encodeURIComponent(query) + '&lang=' + encodeURIComponent(langVal) + '&count=20&start=' + (catalogPage * 20));
    const data = await res.json();
    if (data.error) { results.innerHTML = '<div class="empty"><p>' + esc(data.error) + '</p></div>'; return; }

    let h = '';
    if (!append) h = '<div style="font-size:12px;color:var(--text2);margin-bottom:12px">' + esc(String(data.total)) + ' ZIMs available</div>';
    for (const item of data.items) {
      const sizeGB = (item.size_bytes / (1024 ** 3)).toFixed(1);
      const articles = item.article_count ? item.article_count.toLocaleString() + ' articles' : '';
      h += '<div class="catalog-item">' +
        '<div class="ci-info">' +
          '<div class="ci-title">' + esc(item.title || item.name) + '</div>' +
          (item.summary ? '<div class="ci-summary">' + esc(item.summary) + '</div>' : '') +
          '<div class="ci-meta">' + [articles, sizeGB + ' GB', item.language].filter(Boolean).join(' &middot; ') + '</div>' +
        '</div>' +
        '<div class="ci-actions">' +
          (item.installed
            ? '<span class="ci-installed">Installed</span>'
            : (item.download_url
              ? '<button class="ci-add-btn" onclick="downloadZim(\'' + escAttr(item.download_url) + '\', this)">+ Add</button>'
              : '')) +
        '</div>' +
      '</div>';
    }
    if (data.items.length >= 20 && (catalogPage + 1) * 20 < data.total) {
      h += '<div style="text-align:center;padding:12px"><button class="manage-btn-action" onclick="catalogPage++;searchCatalog(true)" style="background:var(--surface2);color:var(--text);border:1px solid var(--border)">Load more</button></div>';
    }

    if (append) {
      const old = results.querySelector('[style*="text-align:center"]');
      if (old) old.remove();
      results.insertAdjacentHTML('beforeend', h);
    } else {
      results.innerHTML = h;
    }
  } catch(e) {
    results.innerHTML = '<div class="empty"><p>Failed to fetch catalog</p></div>';
  }
}

async function downloadZim(url, btn) {
  if (btn) { btn.disabled = true; btn.textContent = 'Starting...'; }
  try {
    const res = await fetch('/manage/download', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url }),
    });
    const data = await res.json();
    if (data.error) { if (btn) { btn.textContent = 'Error'; } return; }
    if (btn) { btn.textContent = 'Downloading...'; btn.classList.add('ci-installed'); }
    refreshDownloads();
  } catch(e) {
    if (btn) { btn.textContent = 'Error'; }
  }
}

let _dlTimer = null;

async function refreshDownloads() {
  if (_dlTimer) { clearTimeout(_dlTimer); _dlTimer = null; }
  const dlEl = document.getElementById('manage-downloads');
  if (!dlEl) return;
  try {
    const res = await fetch('/manage/downloads');
    const data = await res.json();
    const dls = data.downloads || [];
    if (!dls.length) { dlEl.innerHTML = ''; return; }
    let h = '<div class="manage-card"><h2>Active Downloads</h2>';
    for (const dl of dls) {
      const sizeMB = (dl.size_bytes / (1024 ** 2)).toFixed(0);
      const mins = (dl.elapsed / 60).toFixed(1);
      h += '<div class="dl-item">' +
        '<span class="dl-name">' + esc(dl.filename) + '</span>' +
        '<span class="dl-size">' + sizeMB + ' MB</span>' +
        '<span class="dl-time">' + mins + 'm</span>' +
        (dl.done ? '<span class="dl-done">Done</span>' : '<span class="spinner-inline" style="margin:0"></span>') +
      '</div>';
    }
    h += '</div>';
    dlEl.innerHTML = h;
    if (dls.some(d => !d.done) && mode === 'manage') {
      _dlTimer = setTimeout(refreshDownloads, 5000);
    }
  } catch(e) {}
}

async function triggerUpdate() {
  try {
    await fetch('/manage/update', { method: 'POST' });
  } catch(e) {}
}

async function checkForUpdates() {
  const el = document.getElementById('update-status');
  if (!el) return;
  try {
    const res = await fetch('/manage/check-updates');
    const data = await res.json();
    if (data.count > 0) {
      el.innerHTML = '<span class="mc-label">Updates available</span><span class="mc-value" style="color:var(--amber)">' +
        data.count + ' ZIM' + (data.count > 1 ? 's' : '') + ' can be updated</span>';
      el.style.display = '';
      // Also show update details below the status card
      const details = data.updates.map(u =>
        '<div class="mc-row" style="font-size:12px;padding:2px 0"><span class="mc-label">' + esc(u.title || u.name) +
        '</span><span class="mc-value" style="font-size:11px">' + esc(u.installed_date) + ' → ' + esc(u.latest_date) + '</span></div>'
      ).join('');
      el.insertAdjacentHTML('afterend', details);
    } else {
      el.innerHTML = '<span class="mc-label">Updates</span><span class="mc-value" style="color:var(--text2)">All ZIMs up to date</span>';
      el.style.display = '';
    }
  } catch(e) {
    // Silently fail — update check is optional
  }
}

async function refreshLibrary() {
  try {
    const res = await fetch('/manage/refresh', { method: 'POST' });
    const data = await res.json();
    if (data.status === 'refreshed') {
      try {
        const lr = await fetch('/list');
        zimsCache = await lr.json();
      } catch(e) {}
      renderManage();
    }
  } catch(e) {}
}

// ── Reader ──
function openReader(url) {
  readerOpen = true;
  const reader = document.getElementById('reader');
  const frame = document.getElementById('reader-frame');
  const loading = document.getElementById('reader-loading');

  mainView.classList.add('hidden');
  reader.classList.add('open');
  loading.classList.remove('hidden');

  newtabBtn.href = url;

  frame.onload = function() {
    loading.classList.add('hidden');
  };
  frame.src = url;
  updateTopbar();
}

function openArticle(zim, path) {
  const url = '/w/' + encodeURIComponent(zim) + '/' + path.split('/').map(encodeURIComponent).join('/');
  // Track which ZIM the reader is showing (for topbar badge)
  readerSource = zim;
  // Push history so browser back closes the reader
  history.pushState({ mode: 'reader', zim: zim, path: path }, '', url);
  openReader(url);
}

function closeReader() {
  if (!readerOpen) return;
  readerOpen = false;
  readerSource = null;
  document.getElementById('reader').classList.remove('open');
  document.getElementById('reader-frame').src = 'about:blank';
  mainView.classList.remove('hidden');
  updateTopbar();
}

// ── Random ──
async function randomArticle(event) {
  if (event) event.preventDefault();
  const btn = document.getElementById('random-btn');
  btn.classList.add('rolling');
  setTimeout(() => btn.classList.remove('rolling'), 600);
  const zimParam = currentSource ? '?zim=' + encodeURIComponent(currentSource) : '';
  try {
    const res = await fetch('/random' + zimParam);
    const data = await res.json();
    if (data.error) return;
    openArticle(data.zim, data.path);
  } catch(e) {}
}

// ── Keyboard ──
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (suggestDropdown.style.display !== 'none') { hideSuggest(); return; }
    if (readerOpen) { goBack(); return; }
    if (q.value) { q.value = ''; hideSuggest(); clearSearch(); return; }
    if (mode === 'source' || mode === 'manage') { enterHome(true); return; }
    return;
  }
  const tag = document.activeElement && document.activeElement.tagName;
  if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
  if (e.key === '/' && !e.metaKey && !e.ctrlKey) { e.preventDefault(); q.focus(); }
  if (e.key === 'r' && !e.metaKey && !e.ctrlKey && !e.altKey) { e.preventDefault(); randomArticle(e); }
});

// ── History ──
window.addEventListener('popstate', (e) => {
  hideSuggest();
  // If reader is open, just close it — the previous state is still the search/source view
  if (readerOpen) {
    closeReader();
    // If we came from an auto-reader source, go home
    if (sourceAutoReader) {
      sourceAutoReader = false;
      currentSource = null;
      enterHome(false);
    }
    return;
  }
  // Otherwise normal route
  q.value = '';
  activeCategories.clear();
  activeSourceFilters.clear();
  sourceAutoReader = false;
  route(false);
});

// ── Util ──
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
function escAttr(s) { return esc(s).replace(/'/g, '&#39;').replace(/"/g, '&quot;'); }

init();
</script>
</body>
</html>
