name: Post-Publish

# Triggered when a draft release is manually published.
# Updates the Sparkle appcast, Homebrew cask, and publishes to PyPI.

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  publish-pypi:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install build twine
      - run: python -m build
      - uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

  update-appcast:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download Sparkle tools
        run: |
          curl -sL "https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz" -o /tmp/sparkle.tar.xz
          cd /tmp && tar -xf sparkle.tar.xz

      - name: Download release DMGs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          mkdir -p /tmp/dmgs
          gh release download "$VERSION" --pattern "*.dmg" --dir /tmp/dmgs
          ls -la /tmp/dmgs/

      - name: Sign DMGs and generate appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VNUM="${VERSION#v}"  # strip leading 'v'

          # Import private key for signing
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_key.pem

          # Sign each DMG and collect signatures
          for dmg in /tmp/dmgs/*.dmg; do
            BASENAME=$(basename "$dmg")
            SIG=$(/tmp/bin/sign_update "$dmg" --ed-key-file /tmp/sparkle_key.pem)
            echo "Signed $BASENAME: $SIG"

            # Parse edSignature and length from sign_update output
            ED_SIG=$(echo "$SIG" | grep -o 'sparkle:edSignature="[^"]*"' | cut -d'"' -f2)
            LENGTH=$(echo "$SIG" | grep -o 'length="[^"]*"' | cut -d'"' -f2)

            if [[ "$BASENAME" == *"AppleSilicon"* ]]; then
              ARM_SIG="$ED_SIG"
              ARM_LEN="$LENGTH"
              ARM_URL="https://github.com/epheterson/Zimi/releases/download/${VERSION}/${BASENAME}"
            elif [[ "$BASENAME" == *"Intel"* ]]; then
              INTEL_SIG="$ED_SIG"
              INTEL_LEN="$LENGTH"
              INTEL_URL="https://github.com/epheterson/Zimi/releases/download/${VERSION}/${BASENAME}"
            fi
          done

          rm -f /tmp/sparkle_key.pem

          # Generate appcast.xml with both architectures
          PUBDATE=$(date -u '+%a, %d %b %Y %H:%M:%S %z')

          cat > appcast.xml << XMLEOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>Zimi Updates</title>
              <link>https://github.com/epheterson/Zimi</link>
              <description>Offline knowledge server for ZIM files</description>
              <language>en</language>
              <item>
                <title>Zimi ${VNUM}</title>
                <pubDate>${PUBDATE}</pubDate>
                <sparkle:version>${VNUM}</sparkle:version>
                <sparkle:shortVersionString>${VNUM}</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>13.0</sparkle:minimumSystemVersion>
                <enclosure url="${ARM_URL}" sparkle:edSignature="${ARM_SIG}" length="${ARM_LEN}" type="application/octet-stream" sparkle:os="macos" sparkle:installationType="package">
                  <sparkle:architectures>arm64</sparkle:architectures>
                </enclosure>
                <enclosure url="${INTEL_URL}" sparkle:edSignature="${INTEL_SIG}" length="${INTEL_LEN}" type="application/octet-stream" sparkle:os="macos" sparkle:installationType="package">
                  <sparkle:architectures>x86_64</sparkle:architectures>
                </enclosure>
              </item>
            </channel>
          </rss>
          XMLEOF

          echo "Generated appcast.xml for ${VERSION}"
          cat appcast.xml

      - name: Commit updated appcast
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "Update appcast.xml for ${{ github.event.release.tag_name }}"
          git push

  update-homebrew:
    runs-on: ubuntu-latest
    steps:
      - name: Download release DMGs and compute SHA256
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VNUM="${VERSION#v}"
          mkdir -p /tmp/dmgs
          gh release download "$VERSION" --repo epheterson/Zimi --pattern "*.dmg" --dir /tmp/dmgs

          ARM_SHA=$(sha256sum /tmp/dmgs/Zimi-AppleSilicon.dmg | cut -d' ' -f1)
          INTEL_SHA=$(sha256sum /tmp/dmgs/Zimi-Intel.dmg | cut -d' ' -f1)

          echo "VNUM=$VNUM" >> $GITHUB_ENV
          echo "ARM_SHA=$ARM_SHA" >> $GITHUB_ENV
          echo "INTEL_SHA=$INTEL_SHA" >> $GITHUB_ENV

      - name: Checkout homebrew-zimi
        uses: actions/checkout@v4
        with:
          repository: epheterson/homebrew-zimi
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-zimi

      - name: Update cask formula
        run: |
          cd homebrew-zimi
          cat > Casks/zimi.rb << 'RUBYEOF'
          cask "zimi" do
            arch arm: "AppleSilicon", intel: "Intel"

            version "${{ env.VNUM }}"
            sha256 arm:   "${{ env.ARM_SHA }}",
                   intel: "${{ env.INTEL_SHA }}"

            url "https://github.com/epheterson/Zimi/releases/download/v#{version}/Zimi-#{arch}.dmg"
            name "Zimi"
            desc "Offline knowledge server for ZIM files"
            homepage "https://github.com/epheterson/Zimi"

            depends_on macos: ">= :ventura"

            app "Zimi.app"

            zap trash: [
              "~/.config/zimi",
              "~/Library/Preferences/com.epheterson.zimi.plist",
            ]
          end
          RUBYEOF

      - name: Commit and push
        run: |
          cd homebrew-zimi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/zimi.rb
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "Update Zimi to ${{ env.VNUM }}"
          git push

  publish-snap:
    runs-on: ubuntu-latest
    steps:
      - name: Download Snap from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          gh release download "$VERSION" --repo epheterson/Zimi --pattern "*.snap" || true

      - name: Publish to Snap Store
        if: hashFiles('*.snap') != ''
        uses: snapcore/action-publish@v1
        with:
          snap: "*.snap"
          release: stable
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
